#!/bin/bash
# -----------------------------------------------------------------------------
# Script: common.lib
# Description: Common library functions for Proxmox IaC scripts.
# -----------------------------------------------------------------------------

log() {
    local level="$1"
    local message="$2"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - [$level] - $message" | tee -a "$LOG_FILE"
}

safe_exec() {
    log "EXEC" "Executing command: $@"
    if "$@"; then
        log "SUCCESS" "Command successful: $@"
        return 0
    else
        log "ERROR" "Command failed: $@"
        return 1
    fi
}

apply_and_restart() {
    local vmid="$1"
    local type="$2"
    local tool="$3"
    local args="$4"
    
    log "INFO" "Applying setting '$args' to $vmid and restarting..."
    
    if [[ "$DRY_RUN" == "false" ]]; then
        if safe_exec "$tool" "set" "$vmid" "$args"; then
            if [[ "$type" == "lxc" ]]; then
                safe_exec pct stop "$vmid" && safe_exec pct start "$vmid"
            elif [[ "$type" == "vm" ]]; then
                safe_exec qm stop "$vmid" && safe_exec qm start "$vmid"
            fi
        fi
    fi
}
